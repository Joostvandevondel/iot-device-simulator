const submitDevicesButton=document.querySelector("#submitDevices");const submitAttributesButton=document.querySelector("#submitAttributes");const submitDataValuesButton=document.querySelector("#submitDataValues");const startStreamButton=document.querySelector("#startStream");const submitSdsSettings=document.querySelector("#safeSDSSettings");const skipSdsSettings=document.querySelector("#skipSDS");const createDeviceInputFields=Array.from(document.querySelectorAll(".createDevice"));const createDeviceForm=document.querySelector("#createDevices");const createAttributeForm=document.querySelector(".addAttributes");const controlsForNumberValues=document.querySelector("#controlNumberValues");const controlsForStringValues=document.querySelector("#controlStringValues");const controlsForBooleanValues=document.querySelector("#controlBooleanValues");const photoBanner=document.querySelector("#photos");const addDataValuesForm=document.querySelector(".addDataValues");const selectBoxesDataType=Array.from(document.querySelectorAll("select"));const fileInput=document.querySelector(".deviceImage");const numberValues=[];const booleanValues=[];const stringValues=[];const devicePictures=[];var isSdsProject=false;var sdsSettings={};var numberOfCreateDevicesInputFields=1;var numberOfAttributesCreated={};var devicesData={};const clientId=guid();function pictureSelected(e){var fileName="";var fileUrl="";if(this.files)fileName=e.target.value.split("\\").pop();if(fileName)e.target.previousElementSibling.innerHTML=fileName;else e.target.previousElementSibling.innerHTML="Select Picture (Optional) ...";if(fileInput.files&&fileInput.files[0]){const reader=new FileReader;reader.onload=function(e){devicePictures.push(e.target.result)};const image=reader.readAsDataURL(fileInput.files[0])}}function guid(){function s4(){return Math.floor((1+Math.random())*65536).toString(16).substring(1)}return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function initSliders(){const sliders=Array.from(document.querySelectorAll(".slider.slider-horizontal"));const containers=Array.from(document.querySelectorAll(".sliderContainer"));sliders.forEach(function(slider){slider.style.width="100%"});containers.forEach(function(container){container.addEventListener("click",sliderValueChanged)})}function removeCreatedAttribute(e){const elementToBeRemoved=e.path[2];const parentElement=e.path[3];const device=e.path[3].dataset.device;parentElement.removeChild(elementToBeRemoved);numberOfAttributesCreated[device]--}function removeCreatedDevice(e){const elementToBeRemoved=e.path[3];createDeviceForm.removeChild(elementToBeRemoved);numberOfCreateDevicesInputFields--}function attributeInputFieldClicked(e){const clickedContainer=e.path[3];const device=e.path[3].dataset.device;numberOfAttributesCreated[device]++;const container=document.createElement("div");container.classList="form-group animated slideInRight";const input="<div class='input-group'>"+"<div class='input-group-addon'>Attribute "+numberOfAttributesCreated[device]+"</div>"+"<input type='text' class='form-control createAttribute' id='"+device+"/attribute"+numberOfAttributesCreated[device]+"' placeholder='Attribute Name (No spaces)'>"+"<div class='input-group-addon removeAttribute'>❌</div>"+"</div>";container.innerHTML=input;clickedContainer.appendChild(container);container.firstChild.children[1].addEventListener("click",attributeInputFieldClicked);container.firstChild.children[2].addEventListener("click",removeCreatedAttribute)}function deviceInputFieldClicked(){if(document.querySelectorAll(".createDevice").length<=20){numberOfCreateDevicesInputFields++;const container=document.createElement("div");container.innerHTML="<div class='form-group animated slideInRight'>"+"<div class='input-group'>"+"<div class='input-group-addon'>Device "+numberOfCreateDevicesInputFields+"</div>"+"<input type='text' class='form-control createDevice' id='device"+numberOfCreateDevicesInputFields+"' placeholder='Device Name'>"+"<div class='input-group-addon removeDevice'>❌</div>"+"</div>"+"<label class='btn btn-default btn-file' style='margin-top:10px'>"+"<span class='deviceImageLabel'>Select Picture (Optional) ...</span> <input type='file' class='deviceImage' style='display: none;'>"+"</label>"+"</div>";createDeviceForm.appendChild(container);container.firstChild.firstChild.children[1].addEventListener("click",deviceInputFieldClicked);const label=container.querySelector(".deviceImage");label.addEventListener("change",pictureSelected);container.addEventListener("animationend",function(e){container.firstChild.className="form-group";container.firstChild.firstChild.lastChild.addEventListener("click",removeCreatedDevice)})}}function generateInitialAttributeForm(){const devices=Object.keys(devicesData);devices.forEach(function(device,index){numberOfAttributesCreated[device]=1;const div=document.createElement("div");div.dataset.device=device;const h2=document.createElement("h2");h2.innerHTML=device;div.appendChild(h2);const container=document.createElement("div");container.classList="form-group";const input="<div class='input-group'>"+"<div class='input-group-addon'>Attribute "+numberOfAttributesCreated[device]+"</div>"+"<input type='text' class='form-control createAttribute' id='"+device+"/attribute"+numberOfAttributesCreated[device]+"' placeholder='Attribute Name (No spaces)'>"+"<div class='input-group-addon removeAttribute'>❌</div>"+"</div>";container.innerHTML=input;div.appendChild(container);container.firstChild.children[1].addEventListener("click",attributeInputFieldClicked);document.querySelector(".addAttributes").appendChild(div)})}function generateDataValuesForm(){const devices=Object.keys(devicesData);devices.forEach(function(device){const container=document.createElement("div");container.dataset.device=device;const h2=document.createElement("h2");h2.innerHTML=device;container.appendChild(h2);const attributes=Object.keys(devicesData[device]);attributes.forEach(function(attribute){const form=document.createElement("form");form.classList="form-inline";const p=document.createElement("p");p.innerHTML=attribute;p.classList="attribute";form.appendChild(p);const select=document.createElement("select");select.classList="form-control";select.dataset.attribute=attribute;const options="<option>String</option>"+"<option>Number</option>"+"<option>Boolean</option>"+"<option>GPS-string</option>";select.innerHTML=options;form.appendChild(select);select.addEventListener("change",function(e){const attribute=this.dataset.attribute;const selectedValue=this.value;const categoryInput=form.querySelector("input[data-attribute="+attribute+"]");const rangeInput=form.querySelector("div[data-attribute="+attribute+"]");if(selectedValue==="Number"){categoryInput.style.display="none";rangeInput.style.display="block"}if(selectedValue==="String"){categoryInput.style.display="block";rangeInput.style.display="none"}if(selectedValue==="Boolean"){categoryInput.style.display="none";rangeInput.style.display="none"}});const categoryInput=document.createElement("input");categoryInput.dataset.attribute=attribute;categoryInput.style.width="100%";categoryInput.style.marginTop="10px";categoryInput.dataset.attribute=attribute;categoryInput.type="text";categoryInput.classList="form-control";categoryInput.id="categories";categoryInput.placeholder="Enter Categories (comma seperated)";const rangeContainer=document.createElement("div");rangeContainer.style.display="none";rangeContainer.dataset.attribute=attribute;const fromP=document.createElement("p");fromP.innerHTML="From";rangeContainer.appendChild(fromP);const numberInputFrom=document.createElement("input");numberInputFrom.style.width="100%";numberInputFrom.dataset.attribute=attribute;numberInputFrom.type="number";numberInputFrom.classList="form-control";numberInputFrom.id="range-from";numberInputFrom.placeholder="From";rangeContainer.appendChild(numberInputFrom);const toP=document.createElement("p");toP.innerHTML="To";rangeContainer.appendChild(toP);const numberInputTo=document.createElement("input");numberInputTo.style.width="100%";numberInputTo.dataset.attribute=attribute;numberInputTo.type="number";numberInputTo.classList="form-control";numberInputTo.id="range-to";numberInputTo.placeholder="To";rangeContainer.appendChild(numberInputTo);form.appendChild(categoryInput);form.appendChild(rangeContainer);container.appendChild(form)});addDataValuesForm.appendChild(container)})}function sliderValueChanged(e){const attribute=this.dataset.attribute;const device=this.dataset.device;const inputField=document.querySelector("input[data-attribute="+attribute+"][data-device="+device+"]");const minMax=inputField.dataset.value;const min=minMax.split(",")[0];const max=minMax.split(",")[1];devicesData[device][attribute].min=min;devicesData[device][attribute].max=max}function generateControlPanel(){numberValues.forEach(function(value){const container=document.createElement("div");container.classList="sliderContainer";container.dataset.attribute=value.attributeName;container.dataset.device=value.deviceName;const text=document.createTextNode("Adjust range for "+value.attributeName+" ("+value.deviceName+"):");container.appendChild(text);const slider=document.createElement("input");slider.id=value.attributeName+"-"+value.deviceName;slider.type="text";slider.value="";slider.dataset.sliderMin=parseInt(value.min)-5;slider.dataset.sliderMax=parseInt(value.max)+5;slider.dataset.sliderStep="1";slider.dataset.sliderValue="["+value.min+","+value.max+"]";slider.dataset.attribute=value.attributeName;slider.dataset.device=value.deviceName;container.appendChild(slider);controlsForNumberValues.appendChild(container);$("#"+slider.id).slider();initSliders()});booleanValues.forEach(function(value){const container=document.createElement("div");container.classList="booleanDropdownContainer row";container.dataset.attribute=value.attributeName;container.dataset.device=value.deviceName;const text=document.createElement("p");text.innerHTML="Fix value for "+value.attributeName+" ("+value.deviceName+"):";text.style.paddingLeft="15px";container.appendChild(text);const selectContainer=document.createElement("div");selectContainer.classList="col-md-9";const buttonContainer=document.createElement("div");buttonContainer.classList="col-md-3";const select=document.createElement("select");select.classList="form-control";select.dataset.attribute=value.attributeName;select.dataset.device=value.deviceName;const options=value.categories;const defaultOption=document.createElement("option");defaultOption.innerHTML="--";defaultOption.value="--";select.appendChild(defaultOption);options.forEach(function(option){const opt=document.createElement("option");opt.value=option;opt.innerHTML=option;select.appendChild(opt)});selectContainer.appendChild(select);const nudge=document.createElement("button");nudge.classList="btn btn-danger btn-block nudge";nudge.innerHTML="Nudge!";nudge.dataset.device=value.deviceName;nudge.dataset.attribute=value.attributeName;buttonContainer.appendChild(nudge);container.appendChild(selectContainer);container.appendChild(buttonContainer);controlsForBooleanValues.appendChild(container);initControlPanelDropdowns(".booleanDropdownContainer");initNudgeButtons()});stringValues.forEach(function(value){const container=document.createElement("div");container.classList="stringDropdownContainer";container.dataset.attribute=value.attributeName;container.dataset.device=value.deviceName;const text=document.createTextNode("Fix value for "+value.attributeName+" ("+value.deviceName+"):");container.appendChild(text);const select=document.createElement("select");select.classList="form-control";select.dataset.attribute=value.attributeName;select.dataset.device=value.deviceName;const options=value.categories;const defaultOption=document.createElement("option");defaultOption.innerHTML="--";defaultOption.value="--";select.appendChild(defaultOption);options.forEach(function(option){const opt=document.createElement("option");opt.value=option;opt.innerHTML=option;select.appendChild(opt)});container.appendChild(select);controlsForBooleanValues.appendChild(container);initControlPanelDropdowns(".stringDropdownContainer")})}function initNudgeButtons(){const buttons=Array.from(document.querySelectorAll(".nudge"));buttons.forEach(function(button){button.addEventListener("click",nudge)})}function nudge(e){const device=this.dataset.device;const attribute=this.dataset.attribute;const select=document.querySelector("select[data-device="+device+"][data-attribute="+attribute+"]");const imageToAnimate=document.querySelector("img[id="+device+"]");imageToAnimate.className+="animated tada";imageToAnimate.addEventListener("animationend",function(e){imageToAnimate.removeAttribute("class")});var audio=new Audio("audio/doh.mp3");audio.play();devicesData[device][attribute]["fixedValue"]="true";console.log(devicesData[device][attribute]);setTimeout(function(){devicesData[device][attribute]["fixedValue"]=select.options[select.selectedIndex].value;console.log(devicesData[device][attribute])},4e3)}function initControlPanelDropdowns(selector){const dropdowns=Array.from(document.querySelectorAll(selector));dropdowns.forEach(function(dropdown){dropdown.addEventListener("change",controlPanelDropDownSelected)})}function controlPanelDropDownSelected(e){const attribute=this.dataset.attribute;const device=this.dataset.device;const select=this.querySelector("select");devicesData[device][attribute]["fixedValue"]=select.options[select.selectedIndex].value}function generateImagesInControlPanel(){const devices=Object.keys(devicesData);devices.forEach(function(device,index){const img=document.createElement("img");img.src=devicePictures[index];img.id=device;img.style.width="150px";img.style.height="150px";img.style.borderRadius="50%";img.style.border="2px solid #F2F2F2";img.style.marginLeft="5px";photoBanner.appendChild(img)})}function submitDevices(){devicesData={};Array.from(document.querySelectorAll(".createDevice")).forEach(function(inputField,index){if(!(inputField.value==="")){devicesData[inputField.value]={}}});if(Object.keys(devicesData).length===0&&devicesData.constructor===Object){$.notify({message:"Please fill in at least 1 device."},{type:"danger"})}else{generateInitialAttributeForm();$.notify({message:"Devices saved succesfully!"},{type:"success"});generateImagesInControlPanel();$("#collapseCreateDevices").collapse("hide");$("#collapseAddAttributes").collapse("show")}}function submitAttributes(){const devices=Array.from(document.querySelectorAll("[data-device]"));devices.forEach(function(device){const attributes=Array.from(device.querySelectorAll(".createAttribute"));const name=device.dataset.device;attributes.forEach(function(attribute){if(!(attribute.value==="")){devicesData[name][attribute.value]={}}})});generateDataValuesForm();$.notify({message:"Attributes saved succesfully!"},{type:"success"});$("#collapseAddAttributes").collapse("hide");$("#collapseDataValues").collapse("show")}function submitDataValues(){const devices=Array.from(document.querySelectorAll(".addDataValues div[data-device]"));devices.forEach(function(device){const deviceName=device.dataset.device;const attributes=Array.from(device.querySelectorAll(".attribute"));attributes.forEach(function(attribute){const attributeName=attribute.innerHTML;const selectBoxes=Array.from(device.querySelectorAll("select[data-attribute="+attributeName+"]"));selectBoxes.forEach(function(selectBox){const selectedValue=selectBox.value;devicesData[deviceName][attributeName]["dataType"]=selectedValue;devicesData[deviceName][attributeName]["deviceName"]=deviceName;devicesData[deviceName][attributeName]["attributeName"]=attributeName;if(selectedValue==="String"){const stringInput=device.querySelector("#categories[data-attribute="+attributeName+"]").value;const parsedStringInput=stringInput.split(",");devicesData[deviceName][attributeName]["categories"]=parsedStringInput;stringValues.push(devicesData[deviceName][attributeName])}if(selectedValue==="Number"){const from=device.querySelector("#range-from[data-attribute="+attributeName+"]").value;const to=device.querySelector("#range-to[data-attribute="+attributeName+"]").value;devicesData[deviceName][attributeName]["min"]=from;devicesData[deviceName][attributeName]["max"]=to;numberValues.push(devicesData[deviceName][attributeName])}if(selectedValue==="Boolean"){devicesData[deviceName][attributeName]["categories"]=[true,false];booleanValues.push(devicesData[deviceName][attributeName])}})})});generateControlPanel();$.notify({message:"Data Values saved succesfully!"},{type:"success"});$("#collapseDataValues").collapse("hide");$("#collapseSDSSetup").collapse("show")}function getDataToSend(){const dataToBeSend=[];const devices=Object.keys(devicesData);devices.forEach(function(device){const attributes=Object.keys(devicesData[device]);attributes.forEach(function(attribute,index){var value="";const currentAttribute=devicesData[device][attribute];const hasFixedValue=currentAttribute["fixedValue"]&&currentAttribute["fixedValue"]!=="--";if(currentAttribute["dataType"]==="String"||currentAttribute["dataType"]==="Boolean"){value=hasFixedValue?currentAttribute["fixedValue"]:currentAttribute["categories"][Math.floor(Math.random()*currentAttribute["categories"].length)]}else{value=hasFixedValue?currentAttribute["fixedValue"]:Math.random()*(parseInt(currentAttribute.max)-parseInt(currentAttribute.min))+parseInt(currentAttribute.min)}devicesData[device][attribute]["value"]=""+value;devicesData[device][attribute]["ESP_OPS"]="i";devicesData[device][attribute]["timestamp"]=(new Date).toISOString();dataToBeSend.push(devicesData[device][attribute])})});return dataToBeSend}function sendData(){console.log(getDataToSend())}function startStreaming(){if(isSdsProject){const url="http://"+sdsSettings.serverName+":9093/1/authorization";const credentials=[{privilege:"write",resourceType:"stream",resource:"default/"+sdsSettings.projectName+"/"+sdsSettings.inputStreamName}];var settings={async:true,crossDomain:true,url:url,method:"POST",headers:{authorization:"Basic "+btoa(document.querySelector(".sdsUsername").value+":"+document.querySelector(".sdsPassword").value),"cache-control":"no-cache"},data:JSON.stringify(credentials)};$.ajax(settings).done(function(response){const postUrl="http://"+sdsSettings.serverName+":9093/1/workspaces/default/projects/"+sdsSettings.projectName+"/streams/"+sdsSettings.inputStreamName;const token=JSON.stringify(response).slice(18,-5)+'"';console.log(getDataToSend());setInterval(function(){var settings={async:true,crossDomain:true,url:postUrl,method:"POST",headers:{authorization:'SWS-Token "sws-token"='+token,"cache-control":"no-cache"},data:JSON.stringify(getDataToSend())};$.ajax(settings).done(function(response){console.log("posted successfully, "+response)})},1e3)})}else{setInterval(sendData,1e3)}}function skipSds(){$.notify({message:"No SDS project!"},{type:"success"});$("#collapseControlPanel").collapse("show");$("#collapseSDSSetup").collapse("hide")}function submitSds(){isSdsProject=true;sdsSettings.serverName=document.querySelector(".sdsServerName").value;sdsSettings.projectName=document.querySelector(".sdsProjectName").value;sdsSettings.inputStreamName=document.querySelector(".sdsInputStreamName").value;$.notify({message:"SDS settings saved!"},{type:"success"});$("#collapseControlPanel").collapse("show");$("#collapseSDSSetup").collapse("hide")}createDeviceInputFields.forEach(function(input){input.addEventListener("focus",deviceInputFieldClicked)});submitDevicesButton.addEventListener("click",submitDevices);submitAttributesButton.addEventListener("click",submitAttributes);submitDataValuesButton.addEventListener("click",submitDataValues);startStreamButton.addEventListener("click",startStreaming);skipSdsSettings.addEventListener("click",skipSds);submitSdsSettings.addEventListener("click",submitSds);fileInput.addEventListener("change",pictureSelected);